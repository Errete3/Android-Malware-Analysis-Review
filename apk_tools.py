import zipfile
import os.path
import os
import subprocess


class ApkExtractor:

    def __init__(self, path):
        self.path = path
        self.splitpath = os.path.split(path)
        self.filename = self.splitpath[1]
        self.extracted_directory = os.path.join(self.splitpath[0],'extracted_'+self.filename)

    def zip_extract(self):
        zip = zipfile.ZipFile(self.path, 'r')
        zip.extractall(self.extracted_directory)
        zip.close

    def get_manifest_data(self):
        # Dump manifest file
        command = "aapt d xmltree " + self.path + " AndroidManifest.xml"
        process = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=None, shell=True, executable='/bin/zsh')
        manifest = process.communicate()[0].decode('utf8').split('\n')
        # Get important data as a set
        permissions = list({x.split("\"")[1] for x in manifest if "android.permission" in x})
        intent_filter_action = list({x.split("\"")[1] for x in manifest if "android.intent.action" in x})
        intent_filter_category = list({x.split("\"")[1] for x in manifest if "android.intent.category" in x})
        data = {
            "permissions": permissions,
            "intent_filter_action": intent_filter_action,
            "intent_filter_category": intent_filter_category
        }
        return data

